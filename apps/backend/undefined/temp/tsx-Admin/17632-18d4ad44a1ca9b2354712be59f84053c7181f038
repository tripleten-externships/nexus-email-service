{"code":"__filename=\"C:\\\\Users\\\\Admin\\\\WebstormProjects\\\\nexus-email-service\\\\apps\\\\backend\\\\app\\\\rest\\\\routes\\\\sendGridHook.ts\";(()=>{\n\"use strict\";var __create=Object.create;var __defProp=Object.defineProperty;var __getOwnPropDesc=Object.getOwnPropertyDescriptor;var __getOwnPropNames=Object.getOwnPropertyNames;var __getProtoOf=Object.getPrototypeOf;var __hasOwnProp=Object.prototype.hasOwnProperty;var __name=(target,value)=>__defProp(target,\"name\",{value,configurable:true});var __export=(target,all)=>{for(var name in all)__defProp(target,name,{get:all[name],enumerable:true})};var __copyProps=(to,from,except,desc)=>{if(from&&typeof from===\"object\"||typeof from===\"function\"){for(let key of __getOwnPropNames(from))if(!__hasOwnProp.call(to,key)&&key!==except)__defProp(to,key,{get:()=>from[key],enumerable:!(desc=__getOwnPropDesc(from,key))||desc.enumerable})}return to};var __toESM=(mod,isNodeMode,target)=>(target=mod!=null?__create(__getProtoOf(mod)):{},__copyProps(isNodeMode||!mod||!mod.__esModule?__defProp(target,\"default\",{value:mod,enumerable:true}):target,mod));var __toCommonJS=mod=>__copyProps(__defProp({},\"__esModule\",{value:true}),mod);var sendGridHook_exports={};__export(sendGridHook_exports,{default:()=>sendGridHook_default});module.exports=__toCommonJS(sendGridHook_exports);var import_client_sqs=require(\"@aws-sdk/client-sqs\");var import_util_user_agent_node=require(\"@aws-sdk/util-user-agent-node\");var import_log=__toESM(require(\"../../../logging/log\"));var express=__toESM(require(\"express\"));const SQS_QUEUE_URL=process.env.SENDGRID_EVENTS_QUEUE_URL;const CURRENT_AWS_REGION=process.env.CURRENT_AWS_REGION||\"us-east-1\";const isOffline=process.env.DEPLOYMENT_ENV===\"local\";async function createSqsClient(){const userAgent=await(0,import_util_user_agent_node.createDefaultUserAgentProvider)({serviceId:\"nexus-sendgrid-hook\",clientVersion:\"3.435.0\"})();const config={region:CURRENT_AWS_REGION,customUserAgent:userAgent};if(isOffline){config.endpoint=\"http://127.0.0.1:9324\"}return new import_client_sqs.SQSClient(config)}__name(createSqsClient,\"createSqsClient\");const sqsClientPromise=createSqsClient();const router=express.Router();const eventRecordProperties=[\"event\",\"timestamp\",\"reason\",\"status\",\"ip\",\"url\",\"response\",\"sendId\",\"sg_event_id\",\"attempt\"];function chunkArray(array,size){const chunks=[];for(let i=0;i<array.length;i+=size){chunks.push(array.slice(i,i+size))}return chunks}__name(chunkArray,\"chunkArray\");router.post(\"/webhook/sendgrid\",async(req,res)=>{const events=req.body;let totalSuccessful=0;let totalFailed=0;if(!events||!Array.isArray(events)){import_log.default.warn(\"Received invalid or empty events array from SendGrid.\");return res.status(400).json({error:\"Invalid events array\"})}try{import_log.default.debug(`${JSON.stringify(req.body)}`);const sqsClient=await sqsClientPromise;const messages=events.map(event=>{import_log.default.info(`Processing event: ${JSON.stringify(event)}`);const record=eventRecordProperties.reduce((rec,field)=>{if(event[field]){rec[field]=event[field]}return rec},{});const eventId=event.sg_event_id;return{Id:eventId,MessageBody:JSON.stringify(record),MessageDeduplicationId:eventId,MessageGroupId:\"SendGridEvents\"}});const batches=chunkArray(messages,10);import_log.default.debug(`Checking batches: ${JSON.stringify(batches)}`);const promises=batches.map(chunk=>{const sendCommand=new import_client_sqs.SendMessageBatchCommand({QueueUrl:SQS_QUEUE_URL,Entries:chunk});return sqsClient.send(sendCommand)});const results=await Promise.allSettled(promises);results.forEach(result=>{if(result.status===\"fulfilled\"){const response=result.value;if(response.Successful){totalSuccessful+=response.Successful.length}if(response.Failed&&response.Failed.length>0){totalFailed+=response.Failed.length;import_log.default.warn(`Failed to send batch of ${response.Failed.length} messages: `,response.Failed)}}else{totalFailed+=1;import_log.default.error(\"Error sending batch: \",result.reason)}});import_log.default.info(`Processed and sent ${totalSuccessful} SendGrid mail delivery events to SQS. Total failures: ${totalFailed}.`)}catch(error){import_log.default.error(error);return res.status(500).json({error:\"Internal server error\"})}return res.status(200).json(\"success\")});var sendGridHook_default=router;\n})()\n","warnings":[],"map":{"version":3,"mappings":"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","names":["log"],"ignoreList":[],"sources":["C:\\Users\\Admin\\WebstormProjects\\nexus-email-service\\apps\\backend\\app\\rest\\routes\\sendGridHook.ts"],"sourcesContent":[null]}}